# Лабораторная работа №3

## Обфускатор

В данной работе использовался C# обфускатор BitMono (https://github.com/sunnamed434/BitMono?tab=readme-ov-file)

Обфускатор используется модификации и усложнения кода программы, чтобы затруднить анализ его работы.

Для работы требуется указать путь к exe файлу и другие параметры в интерфейсе приложения.

BitMono использует библиотеку AsmResolver для работы со сборками.

Программа предоставляет множество способов обфускации.

В данной работе использовались следующие ее виды:

ObjectReturnType – меняет nonvoid типы, возвращаемые методом, на object типы;

NoNamespaces – убирает все пробелы;

FullRenamer – меняет имена типов, методов, полей, однако игнорирует отражения, методы Unity и некоторые другие фреймворки. Имеется возможность настроить какие строки необходимо игнорировать.

AntiDebugBreakpoints – добавляет в тела функций определенный таймер, который проверяет, что прошло больше определенного времени с последнего запуска, что вызывает краш программы.

<img width="462" height="608" alt="Методы протекции" src="https://github.com/user-attachments/assets/0d6f4eec-69a8-4dba-afba-5b16443f71f9" />

## Исходный код

    using System;
    using System.Diagnostics;
    using System.IO;
    namespace LabWork
    {
    class Program
    {
        static void Main(string[] args)
        {
            // 1. Вывод в консоль фамилий выполнивших работу
            Console.WriteLine("Лабораторную работу выполнили: Курдюков Илья, Солодкин Сергей");
            Console.WriteLine($"Текущий пользователь ОС: {Environment.UserName}");
            Console.WriteLine($"Текущая рабочая директория: {Environment.CurrentDirectory}\n");
            // 2. Реализация системного вызова: запуск стандартного системного приложения
            Console.WriteLine("[+] Выполняем системный вызов...");
            try
            {
                // Пытаемся запустить 'notepad.exe' - он есть в любой версии Windows
                // и его путь не зависит от пользователя (находится в system32)
                Process.Start("notepad.exe");
                Console.WriteLine("[+] Блокнот (notepad.exe) запущен успешно.");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[!] Ошибка при системном вызове: {ex.Message}"); 
            }
            // 3. Вывод списка файлов и каталогов из папки Documents ТЕКУЩЕГО пользователя
            Console.WriteLine("\n[+] Содержимое каталога Documents текущего пользователя:");
            // Ключевое изменение: используем специальную папку, а не жесткий путь.
            string documentsPath = Environment.GetFolderPath(Environment.SpecialFolder.MyDocuments);
            // Проверяем, существует ли вообще путь к Documents у этого пользователя
            if (string.IsNullOrEmpty(documentsPath))
            {
                Console.WriteLine("[!] Не удалось определить путь к папке Documents."); 
            }
            else if (!Directory.Exists(documentsPath))
            {
                Console.WriteLine($"[!] Каталог не найден: {documentsPath}");  
            }
            else
            {
                Console.WriteLine($"Путь: {documentsPath}\n");
                try
                {            
                    // Вывод каталогов                  
                    Console.WriteLine("--- Каталоги ---");                    
                    string[] directories = Directory.GetDirectories(documentsPath);                   
                    foreach (var dir in directories)                   
                    {                  
                        // Выводим только имя папки, а не полный путь                       
                        Console.WriteLine($"   [DIR] {Path.GetFileName(dir)}");
                    }
                    // Вывод файлов
                    Console.WriteLine("\n--- Файлы ---");
                    string[] files = Directory.GetFiles(documentsPath);
                    foreach (var file in files)
                    {
                        // Выводим только имя файла и его размер
                        FileInfo fileInfo = new FileInfo(file);
                        Console.WriteLine($"   [FILE] {Path.GetFileName(file),-30} Размер: {fileInfo.Length,10} байт");
                    }
                }
                catch (UnauthorizedAccessException)
                {
                    Console.WriteLine("[!] Ошибка доступа: нет прав на чтение каталога.");
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"[!] Неожиданная ошибка при чтении каталога: {ex.Message}");
                }
            }
            Console.WriteLine("\nНажмите любую клавишу для выхода...");
            Console.ReadKey();
        }
    }
    }

Исходная программа выполняет следующие функции:

1) Вывод системной информации

    а) Информация о исполнителях работы

    б) Имя текущего пользователя ОС

    в) Текущая рабочая директория

2) Системный вызов

    а) Запуск процесса notepad.exe через Process.Start()

    б) Обработка возможных исключений

    в) Работа с файловой системой

3) Получение пути к папке Documents текущего пользователя

    а) Рекурсивный вывод списка каталогов и файлов

    б) Отображение размеров файлов

    в) Обработка ошибок доступа

Декомпилированный исходный код:
<img width="827" height="646" alt="Декомпилированный исходник" src="https://github.com/user-attachments/assets/aa6942a7-cb5b-43da-948d-8d0f31b6cedb" />


## Обфусцированный код

После обработки BitMono наблюдаются значительные изменения:

1) Изменение именования

    а) Метод Main переименован в "Register get_help get_help.GetTypesFromParentClass"

    б) Параметры метода имеют бессмысленные имена

2) Добавление мусорного кода

    а) Появились дополнительные операции (call DateTime.get_UtcNow)

    б) Добавлены фиктивные локальные переменные (V15, V16, V17)

3) Изменение структуры метода

    а) Увеличилось количество локальных переменных с 14 до 17

    б) Добавлены дополнительные операции в начале метода

4) Частичное шифрование строк

    а) Некоторые строковые константы остались читаемыми

    б) Отдельные строки подверглись преобразованию

Декомпилированный код после обфускации
<img width="978" height="693" alt="Декомпилированный файл после обфускатора" src="https://github.com/user-attachments/assets/d5f6543e-eea5-4333-bef6-fc7d4a9845fe" />

## Сравнительный анализ

Исходный код в IDA (отображается читаемо)

    1. Метод Main имеет понятное имя и структуру

    2. Строковые константы читаемы: "Лабораторную работу выполнили...", "notepad.exe"

    3. Вызовы методов четко идентифицируемы: Console.WriteLine, Process.Start, Environment.UserName

    4. Локальные переменные имеют стандартные имена (V0, V1, V2...)

    5. Отсутствует мусорный код, логика программы прослеживается четко

Сравнение

1) Увеличение сложности анализа:

    - Имена методов стали бессмысленными, затрудняя понимание логики

    - Добавление мусорного кода усложняет трассировку выполнения

    - Увеличение размера метода затрудняет статический анализ

2) Сохраненная функциональность:

    - Основная логика программы остается неизменной

    - Критические системные вызовы сохраняются

    - Структура обработки исключений не нарушена

3) Эффективность обфускации:

    - Затруднено понимание назначения метода

    - Усложнена реверс-инженерия бизнес-логики

    - Сохранена работоспособность программы

Наглядное сравнение структуры:

<img width="515" height="675" alt="Наглядное сравнение структуры" src="https://github.com/user-attachments/assets/19f683ae-012b-492d-8c23-300324fd5469" />



